name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Release tag to sync (e.g. v0.1.0). Optional."
        required: false
        type: string

permissions:
  contents: read

jobs:
  update-homebrew:
    name: Update Homebrew tap
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve release tag
        id: release
        env:
          EVENT_TAG: ${{ github.event.release.tag_name }}
          INPUT_TAG: ${{ github.event.inputs.version }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if [[ -n "${EVENT_TAG:-}" ]]; then
            tag="$EVENT_TAG"
          elif [[ -n "${INPUT_TAG:-}" ]]; then
            tag="$INPUT_TAG"
          else
            tag=$(gh release list --repo "${{ github.repository }}" --limit 1 --json tagName -q '.[0].tagName')
          fi

          if [[ -z "${tag:-}" ]]; then
            echo "::error::Could not resolve a release tag. Re-run with workflow_dispatch input 'version' (for example: v0.1.0)."
            exit 1
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "bare_version=${tag#v}" >> "$GITHUB_OUTPUT"

      - name: Download SHA256SUMS
        run: |
          set -euo pipefail
          url="https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/SHA256SUMS"
          if ! curl -fsSL "$url" -o SHA256SUMS; then
            echo "::error::Failed to download SHA256SUMS from release ${{ steps.release.outputs.tag }}."
            echo "Confirm release artifacts are published, then rerun this workflow."
            exit 1
          fi

      - name: Generate formula
        run: |
          python3 - <<'PYEOF'
          import pathlib
          import textwrap

          version = "${{ steps.release.outputs.tag }}"
          bare = "${{ steps.release.outputs.bare_version }}"

          sums = {}
          for line in pathlib.Path("SHA256SUMS").read_text().strip().splitlines():
              digest, name = line.split(maxsplit=1)
              sums[name.strip()] = digest

          targets = {
              "aarch64-apple-darwin": ("on_macos", "on_arm"),
              "x86_64-apple-darwin": ("on_macos", "on_intel"),
              "aarch64-unknown-linux-gnu": ("on_linux", "on_arm"),
              "x86_64-unknown-linux-gnu": ("on_linux", "on_intel"),
          }

          blocks = []
          current_os = None
          for target, (os_block, arch_block) in targets.items():
              asset = f"profile-{version}-{target}.tar.gz"
              sha = sums.get(asset)
              if not sha:
                  raise SystemExit(
                      f"Missing checksum for {asset}. "
                      "Regenerate release artifacts and rerun this workflow."
                  )
              if os_block != current_os:
                  if current_os is not None:
                      blocks.append("  end")
                  blocks.append(f"\n  {os_block} do")
                  current_os = os_block
              blocks.append(f"    {arch_block} do")
              blocks.append(f'      url "https://github.com/cmdrvl/profile/releases/download/{version}/{asset}"')
              blocks.append(f'      sha256 "{sha}"')
              blocks.append("    end")
          blocks.append("  end")

          formula = f'''# typed: false
          # frozen_string_literal: true

          class Profile < Formula
            desc "Create, validate, and freeze column-scoping profiles"
            homepage "https://github.com/cmdrvl/profile"
            version "{bare}"
            license "MIT"
          {"".join(chr(10) + line for line in blocks)}

            def install
              bin.install "profile"
            end

            test do
              assert_match version.to_s, shell_output("#{{bin}}/profile --version")
            end
          end
          '''

          pathlib.Path("profile.rb").write_text(textwrap.dedent(formula).lstrip())
          PYEOF

      - name: Validate tap token
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "::error::Missing HOMEBREW_TAP_TOKEN. Add a token with push access to cmdrvl/homebrew-tap and rerun."
            exit 1
          fi

      - name: Push formula to tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail

          git clone "https://x-access-token:${GH_TOKEN}@github.com/cmdrvl/homebrew-tap.git" tap
          mkdir -p tap/Formula
          cp profile.rb tap/Formula/profile.rb
          cd tap

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No formula changes required for ${{ steps.release.outputs.tag }}"
            exit 0
          fi

          git add Formula/profile.rb
          git commit -m "profile ${{ steps.release.outputs.tag }}"
          git push
